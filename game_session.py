from google import genai
from google.genai import types
import re

from config import Config
import image_gen
import db

# === –°–õ–û–í–ê–†–¨ –°–ï–¢–¢–ò–ù–ì–û–í (–ú–ò–†–û–í) ===
SETTINGS = {
    "1": {
        "name": "üöÄ –ö–æ—Å–º–æ—Å",
        "prompt": """–¢—ã - –±–æ—Ä—Ç–æ–≤–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ—Ä–∞–±–ª—è –≤ –±–µ–¥–µ.
                     –°—Ç–∏–ª—å: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, —Ç—Ä–µ–≤–æ–∂–Ω—ã–π.
                     –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: —Ä–∞–∑–≥–µ—Ä–º–µ—Ç–∏–∑–∞—Ü–∏—è, –º–æ–¥—É–ª—å, —Å–µ–∫—Ç–æ—Ä, –∫–∏—Å–ª–æ—Ä–æ–¥."""
    },
    "2": {
        "name": "üè∞ –§—ç–Ω—Ç–µ–∑–∏",
        "prompt": """–¢—ã - –º–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π –≤ –º–∏—Ä–µ –º–µ—á–µ–π –∏ –º–∞–≥–∏–∏.
                     –°—Ç–∏–ª—å: —ç–ø–∏—á–µ—Å–∫–∏–π, –∑–∞–≥–∞–¥–æ—á–Ω—ã–π, —Å—Ç–∞—Ä–∏–Ω–Ω—ã–π.
                     –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–µ, –≥–∏–ª—å–¥–∏—è, –¥—Ä–µ–≤–Ω–∏–π, –º–∞–Ω–∞, –∫–ª–∏–Ω–æ–∫."""
    },
    "3": {
        "name": "üßü –ó–æ–º–±–∏-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å",
        "prompt": """–¢—ã - —Ä–∞—Ü–∏—è –≤—ã–∂–∏–≤—à–µ–≥–æ –≤ –º–∏—Ä–µ –ø–æ—Å–ª–µ —ç–ø–∏–¥–µ–º–∏–∏.
                     –°—Ç–∏–ª—å: –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–π, –æ—Ç—á–∞—è–Ω–Ω—ã–π, –≥—Ä—É–±—ã–π.
                     –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: —É–∫—Ä—ã—Ç–∏–µ, –ø—Ä–∏–ø–∞—Å—ã, –æ—Ä–¥–∞, –∑–∞—Ä–∞–∂–µ–Ω–Ω—ã–µ, –ø–∞—Ç—Ä–æ–Ω—ã."""
    },
    "4": {
        "name": "üïµÔ∏è –ù—É–∞—Ä-–î–µ—Ç–µ–∫—Ç–∏–≤",
        "prompt": """–¢—ã - –≤–µ–¥—É—â–∏–π —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–≤–µ—Å—Ç–∞ –≤ —Å—Ç–∏–ª–µ –ù—É–∞—Ä-–¥–µ—Ç–µ–∫—Ç–∏–≤–∞ 1940-—Ö –≥–æ–¥–æ–≤.
                     –°—Ç–∏–ª—å: –º—Ä–∞—á–Ω—ã–π, —Ü–∏–Ω–∏—á–Ω—ã–π, –¥–æ–∂–¥–ª–∏–≤—ã–π –≥–æ—Ä–æ–¥, –¥–∂–∞–∑.
                     –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: —É–ª–∏–∫–∞, —Ä–µ–≤–æ–ª—å–≤–µ—Ä, —Ä–æ–∫–æ–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞, –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä."""
    }
}

# –ö–æ–¥—ã –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ (—á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, –∫–∞–∫–æ–π —ç—Ç–æ –º–∏—Ä: space/fantasy...)
WORLD_CODES = {
    "1": "space",
    "2": "fantasy",
    "3": "zombie",
    "4": "noir"
}

class GameSession:
    def __init__(self, user_id):
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∂–º–µ—Ç /start
        """
        self.user_id = user_id
        self.client = genai.Client(api_key=Config.GOOGLE_API_KEY)
        self.chat = None         # –¢—É—Ç –±—É–¥–µ—Ç –∂–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Gemini
        self.world_type = None   # –¢—É—Ç –±—É–¥–µ—Ç —Ç–∏–ø –º–∏—Ä–∞ ("space", "fantasy")
        self.is_active = False   # –ù–∞—á–∞—Ç–∞ –ª–∏ –∏–≥—Ä–∞?

    def start_game(self, setting_key):
        """
        –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–≥—Ä—É –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç Gemini.
        –ê–Ω–∞–ª–æ–≥ —Ç–≤–æ–µ–π —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ create_game.
        """
        if setting_key not in SETTINGS:
            return None # –û—à–∏–±–∫–∞, –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ –º–∏—Ä–∞

        setting = SETTINGS[setting_key]
        self.world_type = WORLD_CODES[setting_key] # –°–æ—Ö—Ä–∞–Ω—è–µ–º "fantasy" –∏–ª–∏ "space"
        
        # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–º–ø—Ç (—Ç–æ—Ç –∂–µ, —á—Ç–æ –±—ã–ª —É —Ç–µ–±—è)
        full_prompt = f"""{setting['prompt']}
        
        –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
        - –í –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç–æ–π.
        - –û–ø–∏—Å—ã–≤–∞–π —Å–∏—Ç—É–∞—Ü–∏—é –∫—Ä–∞—Ç–∫–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
        - –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∫–æ–Ω—Ü–µ.
        - –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã.

        –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û –ú–ï–•–ê–ù–ò–ö–ò:
        –ï—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ –ø–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–Ω –∏–ª–∏ –ª–µ—á–∏—Ç—Å—è, –¢–´ –û–ë–Ø–ó–ê–ù –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞ —Ç–µ–≥:
        [HP: -—á–∏—Å–ª–æ] –∏–ª–∏ [HP: +—á–∏—Å–ª–æ]

        –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ —ç—Ç–æ—Ç —Ç–µ–≥, –µ—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
        
        –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û –û–ö–†–£–ñ–ï–ù–ò–Ø:
        –¢–´ –û–ë–Ø–ó–ê–ù –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞ —Ç–µ–≥, –Ω–∞–ø—Ä–∏–º–µ—Ä:
        [IMG: –º—Ä–∞—á–Ω—ã–π –∑–∞–º–æ–∫ –Ω–∞ –≥–æ—Ä–µ]

        –í–°–ï–ì–î–ê –ø–∏—à–∏ —ç—Ç–æ—Ç —Ç–µ–≥.

        –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
        [–û–ø–∏—Å–∞–Ω–∏–µ...]
        –í–∞—Ä–∏–∞–Ω—Ç—ã:
        1. ...
        2. ...
        üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: [—Å–ø–∏—Å–æ–∫]
        ‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: 100%
        """
        
        # –°–æ–∑–¥–∞–µ–º —á–∞—Ç
        self.chat = self.client.chats.create(
            model="gemini-2.5-flash",
            config=types.GenerateContentConfig(system_instruction=full_prompt)
        )
        self.is_active = True
        
        # –î–µ–ª–∞–µ–º –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
        response = self.chat.send_message("–ù–∞—á–Ω–∏ –∏–≥—Ä—É. –í–≤–µ–¥–∏ –≤ –∫—É—Ä—Å –¥–µ–ª–∞.")
        return response.text


    def make_move(self, user_text):
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ö–æ–¥ –∏–≥—Ä–æ–∫–∞:
        1. –î–æ—Å—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î.
        2. –®–ª–µ—Ç –≤ AI.
        3. –ü–∞—Ä—Å–∏—Ç RegEx.
        4. –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î.
        """
        if not self.chat:
            return "–û—à–∏–±–∫–∞: –ò–≥—Ä–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞."

        # 1. –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É –∏–∑ –ë–î
        stats = db.get_stats(self.user_id)
        if not stats:
            return "–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø–∏—à–∏ /start"
            
        hp, money, xp, inv = stats

        # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = f"[–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–∞: –ó–¥–æ—Ä–æ–≤—å–µ: {hp}, –ú–æ–Ω–µ—Ç—ã: {money}, XP: {xp}, –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: {inv}]. –î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞: {user_text}"

        # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI
        response = self.chat.send_message(context)
        ai_text = response.text

        # 4. –ò—â–µ–º RegEx (HP)
        match = re.search(r'\[HP: ([+-]?\d+)\]', ai_text)
        clean_text = ai_text
        
        if match:
            clean_text = ai_text.replace(match.group(0), "").strip()
            hp_change = int(match.group(1))
            db.change_hp(self.user_id, hp_change) # –û–±–Ω–æ–≤–ª—è–µ–º –ë–î

        # 5. –ò—â–µ–º RegEx (IMG)
        img_match = re.search(r'\[(IMG w+)\]', clean_text)
        final_text = clean_text
        image_url = ""
        if img_match:
            final_text = clean_text.replace(img_match.group(0), "").strip()
            image_url = image_gen.generate_location_image(prompt_text=img_match.group(1))

        # –ù–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—É –∑–∞ —Ö–æ–¥
        db.add_xp(self.user_id, 5)
        db.add_money(self.user_id, 10)

        return [final_text, image_url]